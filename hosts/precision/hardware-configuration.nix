# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [
      (modulesPath + "/installer/scan/not-detected.nix")
      ../common/optional/encrypted-root.nix
      ../common/optional/ephemeral-btrfs.nix
    ];

    boot.initrd = {
      availableKernelModules = [
        "nvme"
        "xhci_pci"
        "ahci"
        "usb_storage"
        "sd_mod"
        # TODO Decide what the followings are useful for
        "rtsx_pci_sdmmc"
        "virtio_pci"
        "virtio_blk"
      ];
    kernelModules = [ "i915" ];
  };

  # vhost_vsock: Enables the capacity to launch vm with a virtual socket (network)
  boot.kernelModules = [ "kvm-intel" "nvidia" "vhost_vsock"];
  #boot.blacklistedKernelModules = lib.mkDefault [ "nouveau" ];
  boot.extraModulePackages = [ config.boot.kernelPackages.nvidia_x11 ];

  # Bootloader.
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # TODO Setup keyfile
  #boot.initrd.secrets = {
  #  "/crypto_keyfile.bin" = null;
  #};

  # ip forwarding is needed for NAT'ing to work.
  boot.kernel.sysctl = {
    "net.ipv4.conf.all.forwarding" = true;
    "net.ipv4.conf.default.forwarding" = true;
  };

  boot.kernelParams = [
    "mem_sleep_default=deep"
    "ibt=off"
    #"intel_iommu=igfx_off"
    "nvidia-drm.modeset=1"
    #"i915.enable_psr=0" # Panel Self Refresh (PSR) is a power saving feature that might cause flickering
  ];

  fileSystems = {
    "/boot" = {
      device = "/dev/disk/by-label/ESP";
      fsType = "vfat";
    };
  };

  swapDevices = [
    {
      device = "/swap/swapfile";
      size = 32768;
    }
  ];

  # Enable hibernation
  #swapDevices = [
  #  { device = "/dev/disk/by-uuid/your-swap-uuid"; }
  #];
  #powerManagement.resumeCommands = ''
  #  cryptsetup open /dev/disk/by-uuid/your-luks-uuid root
  #'';
  #powerManagement.hibernateCommands = ''
  #  mount -o subvol=@ /dev/mapper/root /mnt
  #  btrfs filesystem sync /mnt
  #  umount /mnt
  #'';

  nixpkgs.hostPlatform.system = "x86_64-linux";
  powerManagement.cpuFreqGovernor = "powersave";
  hardware.cpu.intel.updateMicrocode = config.hardware.enableRedistributableFirmware;
}
